name: GCP Folder level 

on:
  workflow_dispatch:  # Manual trigger from GitHub UI

jobs:
  onboard:
    runs-on: ubuntu-latest

    
    permissions:
          contents: read
          id-token: write 


    env:
      FOLDER_ID: "93604753456"
      SA_EMAIL: "microsoft-defender-for-servers@sbx-sentinel-mde-dev-920788.iam.gserviceaccount.com"
      AZ_SUBSCRIPTION: "f2e26c0b-8b27-4edd-b6f4-73edc39a4186"
      AZ_RG: "kpmg-testing"
      AZ_LOCATION: "eastus"

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Install Google Cloud CLI
      run: |
        sudo apt-get update
        sudo apt-get install -y apt-transport-https ca-certificates gnupg
        echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
        curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key --keyring /usr/share/keyrings/cloud.google.gpg add -
        sudo apt-get update && sudo apt-get install -y google-cloud-sdk


    - name: Install Azure CLI
      run: |
        curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash

    
    - name: Authenticate to Azure
      env:
        AZURE_CLIENT_ID: "d47fb118-5c46-4069-801d-a7c945665e0f"
        AZURE_CLIENT_SECRET: "NkG8Q~.FzKAZCNttyqvHxAwaeero5ciRepXKDa6Z"
        AZURE_TENANT_ID: "1172494f-68e2-4743-8ebb-b6916a1c681e"
      run: |
            az login --service-principal \
              --username $AZURE_CLIENT_ID \
              --password $AZURE_CLIENT_SECRET \
              --tenant $AZURE_TENANT_ID
            echo "âœ… Azure authentication successful."

    - name: Make script executable
      run: chmod +x onboard_gcp_folder_test.sh

    - name: Run onboarding script
      run: ./onboard_gcp_folder_test.sh
